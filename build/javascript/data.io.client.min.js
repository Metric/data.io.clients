(function() {
var EventEmitter=function(){};EventEmitter.prototype.listeners={},EventEmitter.prototype.on=function(t,e){var r=this.listeners[t];if(r){var n={type:0,fn:e};r.push(n)}else{r=[];var n={type:0,fn:e};r.push(n),this.listeners[t]=r}return this},EventEmitter.prototype.once=function(t,e){var r=this.listeners[t];if(r){var n={type:1,fn:e};r.push(n)}else{r=[];var n={type:1,fn:e};r.push(n),this.listeners[t]=r}return this},EventEmitter.prototype.emit=function(t){var e=[],r=this;arguments.length>1&&(e=Array.prototype.slice.call(arguments,1,arguments.length));var n=this.listeners[t];if(n){for(var s=[],i=0;i<n.length;i++){var p=n[i];p.fn.apply(r,e),1==p.type&&s.push(p)}for(var i=0;i<s.length;i++){var p=s[i];n.splice(n.indexOf(p),1)}}return this};
var Socket=function(){this.ws=null,this.init.apply(this,arguments)};Socket.prototype=Object.create(EventEmitter.prototype),Socket.prototype.init=function(t){var e=this;return this.ws=t,this.connected=!1,this.ws&&(this.ws.onmessage=function(t){e._handleMessage(t.data)},this.ws.onclose=function(t){e.connected=!1,e._broadcast("close",t),e.ws=null},this.ws.onerror=function(t){e.connected=!1,e._broadcast("error",t),e.ws=null},this.ws.onopen=function(){e.connected=!0,e._broadcast("connect")}),this},Socket.prototype._handleMessage=function(t){if("string"==typeof t){var e=JSON.parse(t);e.name&&"string"==typeof e.name&&e.data&&Array.isArray(e.data)?this._broadcast(e.name,e.data):this._broadcast("error",new Error("Invalid Packet: "+t))}return this},Socket.prototype._broadcast=function(t,e){var n=[t];return n=n.concat(e),this._emit.apply(this,n),this},Socket.prototype.close=function(){return this.ws&&this.ws.close(),this},Socket.prototype.connect=function(){!this.ws&&this.uri&&this.init(new ws(this.uri))},Socket.prototype._emit=Socket.prototype.emit,Socket.prototype.emit=function(t){var e=[];arguments.length>1&&(e=Array.prototype.slice.call(arguments,1,arguments.length));var n={name:t,data:e};return this.ws&&this.connected&&this.ws.send(JSON.stringify(n)),this};
var ws=WebSocket||MozWebSocket,DataIO=function(e){if(e||(e="ws://"+window.location.host+"/"),-1==e.indexOf("ws://")&&-1==e.indexOf("wss://"))if(e.indexOf("http://")>-1)e=e.replace("http://","ws://");else if(e.indexOf("https://")>-1)e=e.replace("https://","wss://");else if(e.indexOf(":")>-1){var s=e.indexOf(":");e="ws"+e.substring(s)}else e="ws://"+e;if(ws){var t=new Socket(new ws(e));return t.uri=e,t}return null};window.dio=DataIO;
})();
