(function() {
var EventEmitter=function(){this.listeners={}};EventEmitter.prototype.on=function(t,e){var r=this.listeners[t];if(r){var n={type:0,fn:e};r.push(n)}else{r=[];var n={type:0,fn:e};r.push(n),this.listeners[t]=r}return this},EventEmitter.prototype.once=function(t,e){var r=this.listeners[t];if(r){var n={type:1,fn:e};r.push(n)}else{r=[];var n={type:1,fn:e};r.push(n),this.listeners[t]=r}return this},EventEmitter.prototype.emit=function(t){var e=[],r=this;arguments.length>1&&(e=Array.prototype.slice.call(arguments,1,arguments.length));var n=this.listeners[t];if(n){for(var s=[],i=0;i<n.length;i++){var p=n[i];p.fn.apply(r,e),1==p.type&&s.push(p)}for(var i=0;i<s.length;i++){var p=s[i];n.splice(n.indexOf(p),1)}}return this};
var Socket=function(){this.ws=null,this.emitter=new EventEmitter,this.init.apply(this,arguments)};Socket.prototype.init=function(t){var e=this;return this.ws=t,this.connected=!1,this.ws&&(this.ws.onmessage=function(t){e.handleMessage(t.data)},this.ws.onclose=function(t){e.connected=!1,e.broadcast("close",t)},this.ws.onerror=function(t){e.connected=!1,e.broadcast("error",t)},this.ws.onopen=function(){e.connected=!0,e.broadcast("connect")}),this},Socket.prototype.handleMessage=function(t){if("string"==typeof t){var e=JSON.parse(t);this.broadcast(e.name,e.data)}return this},Socket.prototype.broadcast=function(t,e){var n=[t];return n=n.concat(e),this.emitter.emit.apply(this.emitter,n),this},Socket.prototype.on=function(t,e){return this.emitter.on(t,e),this},Socket.prototype.once=function(t,e){return this.emitter.once(t,e),this},Socket.prototype.close=function(){return this.ws&&this.ws.close(),this},Socket.prototype.emit=function(t){var e=[];arguments.length>1&&(e=Array.prototype.slice.call(arguments,1,arguments.length));var n={name:t,data:e};return this.ws&&this.ws.send(JSON.stringify(n)),this};
var ws=WebSocket||MozWebSocket,DataIO=function(e){if(e||(e="ws://"+window.location.host+"/"),-1==e.indexOf("ws://")&&-1==e.indexOf("wss://"))if(e.indexOf("http://")>-1)e=e.replace("http://","ws://");else if(e.indexOf("https://")>-1)e=e.replace("https://","wss://");else if(e.indexOf(":")>-1){var s=e.indexOf(":");e="ws"+e.substring(s)}else e="ws://"+e;return ws?new Socket(new ws(e)):null};window.dio=DataIO;
})();
